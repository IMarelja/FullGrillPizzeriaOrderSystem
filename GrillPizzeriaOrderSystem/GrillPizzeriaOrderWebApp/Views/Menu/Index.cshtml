@model List<ViewModels.FoodViewModel>
@{

    ViewData["Title"] = "Food Menu";
}

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=add_shopping_cart,search" />

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-center mb-4">Food Menu</h1>
        </div>
    </div>

    <form id="searchForm" class="row g-2">
        <div class="col-md-5">
            <input id="nameSearch" name="search" class="form-control" placeholder="Search food…" />
        </div>
        <div class="col-md-4">
            <select id="categoryFoodListDropdown" name="foodCategoryId" class="form-select">
                <option value="">All categories</option>
            </select>
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-primary" type="submit">Search</button>
        </div>
        <div class="col-md-1 d-grid">
            <a asp-action="Index" class="btn btn-outline-secondary">Clear</a>
        </div>
    </form>

    <div id="adminMenuTools">
        @await Html.PartialAsync("~/Views/Allergen/_Toolbar.cshtml")
    </div>

    <div id="foodGridContainer" class="mt-3">
        <div class="text-muted">Loading…</div>
    </div>
</div>

@section Scripts {
    <!--<script src="~/js/foodCategoryController.js"></script>-->
    <script type="module">

        const $foodNameInput = $('#nameSearch');
        const $categoryFoodListTarget = $('#categoryFoodListDropdown');
        const $searchForm = $('#searchForm');

        const $foodGridTarget = $('#foodGridContainer');
        
        
        function LoadFoodGrid(query, foodCategoryId, page = 1, pageSize = 10) {

            console.log("query: ", query);
			console.log("foodCategoryId: ", foodCategoryId);
            console.log("page: ", page);
			console.log("pageSize: ", pageSize);

            $foodGridTarget.html('<div class="text-muted">Loading…</div>');

            $.ajax({
                url: '@Url.Action("PageSearch", "Food")',
                dataType: 'html',   // we are returning a PartialView
                type: 'GET',
                cache: false,
                data: {
                    search: query,
                    foodCategoryId: foodCategoryId,
                    page: page,
                    pageSize: pageSize
                },
                success: function (html) {
                    renderFoodInsidePartialView(html);
                },
                error: function (xhr, status, err) {
                    console.error('AJAX error:', status, err, 'HTTP:', xhr.status, 'Response:', xhr.responseText);
                    alert('AJAX: Error loading foods');
                }
            });
        }
        
        function LoadFoodCategories(){
            $.ajax({
                url: '/FoodCategory/GetAll',
                dataType: "json",
                type: "GET",
                cache: false,
                success: function (response) {
                    if (response.success) {
                        var categories = response.data; // Array of CategoryFoodViewModel objects

                        // -- Render in DropDown --
                        renderCategoriesAsDropdown(categories);
                    
                    } else {
                        alert(response.message);
                    }
                },
                error: function (xhr, status, err) {
                    console.error('AJAX error:', status, err, 'HTTP:', xhr.status, 'Response:', xhr.responseText);
                    alert('AJAX: Error loading food categories');
                }
            });
        }
        
        $searchForm.on('submit', function(e) {
            e.preventDefault(); // Prevent default form submission
            LoadFoodGrid($foodNameInput.val(), $categoryFoodListTarget.val());
		});

            // Pagination (event delegation)
        $foodGridTarget.on('click', '.js-page-link', function (e) {
            e.preventDefault();
            const page = $(this).data('page');
            if (page) {
                LoadFoodGrid(undefined, undefined, page);
            }
        });

        function renderFoodInsidePartialView(html) {
            $foodGridTarget.html(html);
        }

        function renderCategoriesAsDropdown(categories) {
            var html = '<option value="">All Categories</option>'; // keep default
            categories.forEach(function(category) {
                html += `<option value="${category.id}">${category.name}</option>`;
            });
            $($categoryFoodListTarget).html(html);
        }


        function initialize() {
            LoadFoodCategories();
            LoadFoodGrid('','',1,10);
            //LoadFoodCategories(function(categories) {
            //   renderCategoriesAsDropdown(categories);
            //});
        }

        // Initial on load
        initialize();
    </script>
}


