@model List<ViewModels.FoodViewModel>
@{

    ViewData["Title"] = "Food Menu";
}

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=add_shopping_cart,search" />

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-center mb-4">Food Menu</h1>
        </div>
    </div>

    <form id="searchForm" class="row g-2">
        <div class="col-md-5">
            <input id="nameSearch" name="search" class="form-control" placeholder="Search food…" />
        </div>
        <div class="col-md-4">
            <select id="categoryFoodListDropdown" name="foodCategoryId" class="form-select">
                <option value="">All categories</option>
            </select>
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-primary" type="submit">Search</button>
        </div>
        <div class="col-md-1 d-grid">
            <a asp-action="Index" class="btn btn-outline-secondary">Clear</a>
        </div>
    </form>
    @if (User.Identity.IsAuthenticated
        &&
        User.IsInRole("admin")){
        <div id="adminMenuTools">
            <a class="nav-link"
                asp-controller="Food"
               asp-action="CreateFood">
                Food Create
            </a>
            <a class="nav-link"
                asp-controller="Allergen"
                asp-action="Index">
                Allergen Create/Edit/Delete
            </a>
            <a class="nav-link"
                asp-controller="FoodCategory"
                asp-action="Index">
                Food Category Create/Edit/Delete
            </a>
        </div>
    }

    <div id="foodGridContainer" class="mt-3">
        <div class="text-muted">Loading…</div>
    </div>
</div>

@section Scripts {
    <!--<script src="~/js/foodCategoryController.js"></script>-->
    <script type="module">

        const $foodNameInput = $('#nameSearch');
        const $categoryFoodListTarget = $('#categoryFoodListDropdown');
        const $searchForm = $('#searchForm');

        const $foodGridTarget = $('#foodGridContainer');
        

        
        function LoadFoodGrid(query, foodCategoryId, page = 1, pageSize = 10) {

            $foodGridTarget.html('<div class="text-muted">Loading…</div>');

            $.ajax({
                url: '@Url.Action("PageSearch", "Food")',
                dataType: 'html',   // we are returning a PartialView
                type: 'GET',
                cache: false,
                data: {
                    search: query,
                    foodCategoryId: foodCategoryId,
                    page: page,
                    pageSize: pageSize
                },
                success: function (html) {
                    renderFoodInsidePartialView(html);
                },
                error: function (xhr, status, err) {
                    console.error('AJAX error:', status, err, 'HTTP:', xhr.status, 'Response:', xhr.responseText);
                    alert('AJAX: Error loading foods');
                }
            });
        }
        
        function LoadFoodCategories(){
            $.ajax({
                url: '/FoodCategory/GetAll',
                dataType: "json",
                type: "GET",
                cache: false,
                success: function (response) {
                    if (response.success) {
                        var categories = response.data; // Array of CategoryFoodViewModel objects

                        // -- Render in DropDown --
                        renderCategoriesAsDropdown(categories);
                    
                    } else {
                        alert(response.message);
                    }
                },
                error: function (xhr, status, err) {
                    console.error('AJAX error:', status, err, 'HTTP:', xhr.status, 'Response:', xhr.responseText);
                    alert('AJAX: Error loading food categories');
                }
            });
        }
        
        $searchForm.on('submit', function(e) {
            e.preventDefault(); // Prevent default form submission
            LoadFoodGrid($foodNameInput.val(), $categoryFoodListTarget.val());
		});

            // Pagination (event delegation)
        $foodGridTarget.on('click', '.js-page-link', function (e) {
            e.preventDefault();
            const page = $(this).data('page');
            if (page) {
                LoadFoodGrid(undefined, undefined, page);
            }
        });

        // Order into the cookie
        $foodGridTarget.on('click', '.orderFoodButton', function (e) {
            console.log('Order button clicked');
            e.preventDefault();
            const foodOrderId = $(this).data('food-id');
            console.log(foodOrderId);
            if (foodOrderId) {
                addToOrder(foodOrderId);
            }else{
                alert('❌ Error: Food ID not found.');
		    }
        });

        function renderFoodInsidePartialView(html) {
            $foodGridTarget.html(html);
        }

        function renderCategoriesAsDropdown(categories) {
            var html = '<option value="">All Categories</option>'; // keep default
            categories.forEach(function(category) {
                html += `<option value="${category.id}">${category.name}</option>`;
            });
            $($categoryFoodListTarget).html(html);
        }

        function addToOrder(foodOrderId) {
            $.ajax({
                type: 'POST',
                url: '/Order/AddItem',
                data: {
                    foodId: foodOrderId
                },
                success: function (responce) {
                    if (responce.success) {
                        //$('#cartItemCount').text(responce.count);
                        alert('✅ Item added to cart\nTotal Items: ' + responce.count);
                    } else {
                        alert('❌ ' + (responce?.message ?? 'Failed to add item.'));
                    }
                },
                error: function (xhr, status, err) {
                    console.error('AJAX error:', status, err, 'HTTP:', xhr.status, 'Response:', xhr.responseText);
                    alert('Could not add item to cart do to error in the request.');
                }
            });
		}

        function initialize() {
            LoadFoodCategories();
            LoadFoodGrid('','',1,10);
            //LoadFoodCategories(function(categories) {
            //   renderCategoriesAsDropdown(categories);
            //});
        }

        // Initial on load
        initialize();
    </script>
}


